.TH AOS-UNIT.CONF 5 "2026-02-26" "AosEdge Unit 1.0" "File Formats"
.SH NAME
aos-unit.conf \- Configuration files for AosEdge Unit VM management
.SH SYNOPSIS
.I /etc/aos-unit/unit_config.yaml
.br
.I /etc/aos-unit/runtime.conf
.br
.I /run/aos-unit/network.conf
(runtime-generated)

.SH DESCRIPTION
.B aos-unit
uses two primary configuration files to define VM behavior and infrastructure settings, plus a runtime-generated network configuration file.

.SH UNIT_CONFIG.YAML
.SS Overview
The main configuration file defining VM nodes in YAML format. It dictates the hardware, firmware, and network identity of each virtualized edge node.

.SS Format
.nf
unit:
  node_configs:
    \- name: main
      cpu: 4
      mem: 8G
      ip: 10.200.1.100  # Optional
      arch: amd64       # Optional
      image: custom.qcow2 # Optional
      machine_type: q35 # Optional
      cpu_type: max     # Optional
      uefi: true        # Optional
.fi

.SS Parameters
.TP
.B name
(Required) VM name used for:
.RS
.IP \[bu] 2
Hostname resolution (name.aos-unit)
.IP \[bu]
Image auto-discovery
.IP \[bu]
systemd transient service naming (aos-node-name.service)
.IP \[bu]
MAC address generation (deterministic hash)
.IP \[bu]
Log and UNIX socket naming
.RE

.TP
.B cpu
(Required) Number of virtual CPUs. Integer value (e.g., 2, 4, 8).

.TP
.B mem
(Required) Memory allocation.
.br
Format: <number><unit> where unit is M (megabytes) or G (gigabytes).
.br
Examples: 4G, 8192M, 16G

.TP
.B ip
(Optional) Static IP address for DHCP reservation.
.br
Must be within the automatically-derived bridge subnet (default: 10.200.1.0/24, configurable via DHCP_CIDR).
.br
If omitted, dnsmasq assigns IP from the automatically-calculated DHCP pool (second half of subnet).
.br
Both static and dynamic VMs are accessible via hostname.
.br
Example: 10.200.1.100

.TP
.B arch
(Optional) Guest architecture.
.br
Values: amd64, arm64, x86_64, aarch64
.br
Default: host architecture
.br
Cross-architecture uses TCG (slower than KVM). Note: 32-bit ARM (armv7) is not yet supported.

.TP
.B image
(Optional) Custom image filename.
.br
Default: auto-discovers from name and architecture using naming convention.
.br
Example: custom-vm.qcow2

.TP
.B machine_type
(Optional) QEMU machine type.
.br
Common values: q35 (x86_64), virt (aarch64)
.br
Default: q35 for amd64, virt for arm64

.TP
.B cpu_type
(Optional) QEMU CPU type.
.br
Common values: max, host, cortex-a57, qemu64
.br
Default: max for amd64, cortex-a57 for arm64. (Note: aarch64 with KVM enabled strictly forces 'host').

.TP
.B uefi
(Optional) Boolean to enable/disable UEFI boot firmware.
.br
Values: true, false
.br
Default: false
.br
If omitted from the YAML, but the auto-discovered image filename contains the string "uefi", this parameter will automatically be treated as true. If true, mounts read-only OVMF/AAVMF code and provisions a unique read-write NVRAM variables file per VM.

.SS Parameter Precedence and Defaults
The orchestration engine resolves node parameters using the following strict hierarchy:

.IP 1. 3
.B Explicit YAML Configuration:
Values explicitly defined in \fIunit_config.yaml\fR always take absolute precedence.
.IP 2.
.B Filename Heuristics:
If the \fBuefi\fR value is missing from the YAML, the runner infers it from the auto-discovered image filename. If the filename contains the string "uefi" (e.g., aos-vm-main-amd64-uefi.qcow2), UEFI boot will automatically be enabled.
.IP 3.
.B System Defaults:
If no heuristic applies, the system falls back to safe defaults based on the host system:
.RS
.IP \[bu] 2
\fBarch\fR: Defaults to the host's native architecture.
.IP \[bu]
\fBmachine_type\fR: Defaults to \fBq35\fR (x86_64) or \fBvirt\fR (aarch64).
.IP \[bu]
\fBcpu_type\fR: Defaults to \fBmax\fR (x86_64) or \fBcortex-a57\fR (aarch64). (Overridden to \fBhost\fR if KVM is enabled on aarch64).
.IP \[bu]
\fBip\fR: Defaults to dynamic DHCP allocation from the dnsmasq pool.
.RE

.SS Image Discovery and Formats
If the \fBimage\fR parameter is omitted, the runner searches \fI/var/lib/aos-unit/\fR for a matching disk image.

.B Supported Image Format:
The orchestration engine is strictly limited to \fB.qcow2\fR format disk images. Raw images or other formats are not supported for auto-discovery.

.B Naming Convention Template:
.nf
aos-vm-{name}-{arch_suffix}[-uefi]*.qcow2
.fi

.B Regex Matching Logic:
The runner applies the following regex pattern to discover the correct image:
.nf
^aos-vm-{name}-({arch_suffix}|{legacy_arch}).*\\.qcow2$
.fi
.br
.I Example matches for node "main" (amd64):
.IP \[bu] 2
aos-vm-main-amd64.qcow2
.IP \[bu]
aos-vm-main-amd64-uefi.qcow2
.IP \[bu]
aos-vm-main-qemux86-64.qcow2 (Legacy Yocto naming)

Images must be owned by the \fIaos-unit\fR user to allow QEMU read/write access.

.SH RUNTIME.CONF
.SS Overview
Infrastructure, networking, and runtime configuration settings loaded by the orchestrator and network helper scripts. This file contains a minimal set of parameters; most network configuration is automatically derived at runtime.

.SS Format
.nf
# DHCP subnet CIDR (network configuration auto-derived from this)
DHCP_CIDR="10.200.1.0/24"

# DNS alternative port for dnsmasq sidecar
DNS_ALT_PORT="5300"

# Upstream DNS server for internet resolution
UPSTREAM_DNS="127.0.0.53"

# Internet-facing interface (empty = auto-detect)
INTERNET_INTERFACE=""

# Enable KVM hardware acceleration
ENABLE_KVM="true"
.fi

.SS Parameters
.TP
.B DHCP_CIDR
Network CIDR for the VM subnet. All network parameters (bridge IP, DHCP range, netmask) are automatically calculated from this single value at service startup.
.IP
The bridge IP is assigned as the first usable host address (.1 in the subnet). The DHCP pool starts at the midpoint of usable addresses and extends to the broadcast address minus one.
.IP
\fBSupported prefix length:\fR /8 to /30. Most common deployments use /24 (254 usable hosts). Smaller subnets (/25-/30) are supported but provide fewer DHCP addresses. Very large subnets (/8-/23) work but may be impractical for edge deployments.
.IP
Example:
.RS
.br
DHCP_CIDR="10.200.1.0/24"
.br
Results in:
.br
  Bridge IP: 10.200.1.1
.br
  Netmask: 255.255.255.0
.br
  DHCP Range: 10.200.1.127 to 10.200.1.254
.RE
.IP
Consider using alternative subnets (e.g., 10.200.1.0/24) if your host environment conflicts with common private networks (192.168.x.0/24, 10.0.0.0/8).

.TP
.B DNS_ALT_PORT
Port for the dnsmasq DNS server (sidecar strategy). Uses a non-standard port to avoid conflicts with systemd-resolved on the host. nftables transparently redirects VM DNS queries from port 53 to this alternate port.
.IP
Default: 5300
.br
Note: Do not use port 53, as it will conflict with systemd-resolved.

.TP
.B UPSTREAM_DNS
Upstream DNS server for internet resolution.
.IP
Usually, this configuration assumes
.BR systemd-resolved (8)
is enabled and provides the local stub resolver at 127.0.0.53. If
.BR systemd-resolved (8)
is not running, set this to a reachable upstream DNS resolver address (e.g., 8.8.8.8, 1.1.1.1).
.IP
Default: 127.0.0.53

.TP
.B INTERNET_INTERFACE
Network interface for NAT masquerading to the internet. Empty means auto-detect via default route. Specify manually only if auto-detection fails or you need to force a specific interface.
.IP
Examples: eth0, wlan0, enp0s3
.br
Default: (empty, auto-detect)

.TP
.B ENABLE_KVM
(Optional) Enables QEMU hardware acceleration. If true, the runner verifies host support and access to \fI/dev/kvm\fR. If false, forces software emulation (TCG).
.IP
Default: false

.SH NETWORK.CONF (Runtime-Generated)
.SS Overview
This file is automatically generated by the \fBservice-startup\fR script at service initialization and placed in \fI/run/aos-unit/network.conf\fR. It contains the derived network configuration calculated from \fBDHCP_CIDR\fR and the host's machine-id.

.SS Generated Parameters
.TP
.B BRIDGE_NAME
The deterministic bridge name derived from the host's machine-id: \fBaosbr{machine-id:0:6}\fR.
.br
Example: aosbr3f8a2c (first 6 characters of /etc/machine-id)

.TP
.B BRIDGE_IP
The bridge IP address (first usable host in the subnet).
.br
Calculated as: network_address + 1
.br
Example: 10.200.1.1 (for DHCP_CIDR=10.200.1.0/24)

.TP
.B NETMASK
The subnet netmask in dotted-decimal notation.
.br
Calculated from the CIDR prefix length.
.br
Example: 255.255.255.0 (for /24)

.SS Availability
This file is created during \fBExecStartPre\fR (service-startup phase) and is available to all subsequent orchestrator components via systemd's \fBEnvironmentFile\fR directive. It is automatically removed when the service stops.

.SS Manual Inspection
To view the current runtime network configuration:
.nf
cat /run/aos-unit/network.conf
.fi

.SH NOTES
.IP \(bu 3
The bridge name is no longer user-configurable. It is automatically derived from the host's machine-id to ensure determinism without conflicts.
.IP \(bu
The DNS domain is hardcoded to \fBaos-unit\fR. VMs are always accessible as \fIname.aos-unit\fR from the host.
.IP \(bu
Network parameters (bridge IP, DHCP range, netmask) are automatically calculated. Manual specification is no longer required or supported.
.IP \(bu
Host-side DNS routing for the VM domain is configured via
.BR resolvectl (1)
and therefore requires
.BR systemd-resolved (8)
and D-Bus access (the package installs a Polkit rule for this integration).

.SH YAML PARSER LIMITATIONS
To maintain a minimal footprint without external dependencies, \fBaos-unit\fR uses a lightweight, custom AWK-based YAML parser. It supports only a strict subset of YAML formatting:

.IP \[bu] 2
.B Hierarchy:
The file must start with the top-level key \fBunit:\fR followed by \fBnode_configs:\fR.
.IP \[bu]
.B Indentation:
Indentation must be consistent (spaces only, 2 or 4 spaces recommended).
.IP \[bu]
.B Lists:
List items must start with a dash and a space (e.g., \fB- name: main\fR).
.IP \[bu]
.B Comments:
Inline comments (\fB#\fR) are supported but must be preceded by whitespace or be at the start of a line.
.IP \[bu]
.B Unsupported Features:
Advanced YAML features such as anchors, aliases, multi-line string blocks (> or |), and complex nested dictionaries are \fBNOT\fR supported.

.SH SEE ALSO
.BR aos-unit (8),
.BR systemctl (1),
.BR dnsmasq (8),
.BR nft (8),
.BR qemu (1),
.BR resolvectl (1)

.SH AUTHOR
AosEdge Team <support@aosedge.tech>

.SH COPYRIGHT
Copyright \(co 2018-2026 EPAM Systems Inc.
.br
Licensed under the Apache License, Version 2.0.
