#!/bin/bash
# debian/postinst - AOS Edge Unit post-installation script
set -e

case "$1" in
    configure)
        # Create system user if it doesn't exist
        if ! getent passwd aos-unit >/dev/null 2>&1; then
            adduser --system --group --home /var/lib/aos-unit --shell /bin/bash \
                --gecos "AosEdge Unit Service" aos-unit
        fi

        # Add user to kvm group for /dev/kvm access
        if getent group kvm >/dev/null 2>&1; then
            adduser aos-unit kvm >/dev/null 2>&1 || true
        fi

        # Create directory structure with proper ownership
        install -d -m 0755 -o aos-unit -g aos-unit /var/log/aos-unit
        install -d -m 0755 -o aos-unit -g aos-unit /var/lib/aos-unit

        # Apply sysctl settings
        if command -v sysctl >/dev/null 2>&1; then
            sysctl -p /etc/sysctl.d/99-aos-unit.conf >/dev/null 2>&1 || true
        fi

        # Print installation success message
        cat <<'EOF'

==========================================
AosEdge Unit installation complete!
==========================================

Configuration files:
  /etc/aos-unit/runtime.conf           - Infrastructure settings
  /etc/aos-unit/unit_config.yaml       - Node definitions
Systemd units:
  /lib/systemd/system/aos-unit.service - Main service
  /lib/systemd/system/aos-unit.slice   - Resource management

System user created:
  aos-unit (member of kvm group)

Data directories:
  /var/lib/aos-unit  - VM images
  /var/log/aos-unit  - VM logs

User command:
  aos-unit  - Entry point

Documentation:
  man aos-unit
  man aos-unit.conf

EOF
        ;;

    abort-upgrade | abort-remove | abort-deconfigure)
        # Nothing to do
        ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#
exit 0
